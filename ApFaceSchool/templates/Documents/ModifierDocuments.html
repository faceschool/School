{% extends "Menus/MenuEspaceForm.html" %}
{% block content %}
{% load static %}
<div class="container-fluid">
    <div class="row">
    <div class="col-lg-8 col-md-9 col-sm-9 m-1 table-responsive shadow-card p-3 bg-white">

      <!-- Titre -->
      <div class="text-center mb-3">
        <label class="form-label fw-bold">CLASSE :</label>
        <span class="text-danger fw-bold mx-2">[ {{ nomclasse.NomClasse }} ]</span>
      </div>

      <!-- FILTRES / RECHERCHE -->
      <form class="row g-2 mb-3" method="get">
        <div class="col-auto">
          <input type="text" name="q" class="form-control form-control-sm" placeholder="Recherche (titre/discipline)"
                 value="{{ q }}">
        </div>

        <div class="col-auto">
          <select name="discipline" class="form-select form-select-sm">
            <option value="">Toutes disciplines</option>
            {% for d in disciplines %}
              <option value="{{ d }}" {% if discipline_selected == d %}selected{% endif %}>{{ d }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-auto">
          <select name="typedoc" class="form-select form-select-sm">
            <option value="">Tous types</option>
            {% for t in typedocs %}
              <option value="{{ t }}" {% if typedoc_selected == t %}selected{% endif %}>{{ t }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-auto">
          <select name="per_page" class="form-select form-select-sm">
            <option value="8" {% if page_obj.paginator.per_page|stringformat:"s" == "8" %}selected{% endif %}>8</option>
            <option value="12" {% if page_obj.paginator.per_page|stringformat:"s" == "12" %}selected{% endif %}>12</option>
            <option value="25" {% if page_obj.paginator.per_page|stringformat:"s" == "25" %}selected{% endif %}>25</option>
          </select>
        </div>

        <div class="col-auto">
          <button type="submit" class="btn btn-sm btn-primary">Filtrer</button>
          <a href="{% url 'Modifier_document' pk %}" class="btn btn-sm btn-outline-secondary">Réinitialiser</a>
        </div>
      </form>

      <!-- TABLE (utilisée par Django ou DataTables) -->
      <table id="docsTable" class="table table-striped table-bordered nowrap" style="width:100%">
        <thead class="table-success text-center">
          <tr>
            <th data-data="Discipline">Discipline</th>
            <th data-data="Titre">Titre</th>
            <th data-data="TypeDoc">Type</th>
            <th data-data="Document">Documents</th>
            <th>Solution</th>
            <th>Modifier</th>
            <th>Supprimer</th>
          </tr>
        </thead>

        <tbody>
          {% comment %} Si tu utilises DataTables server-side, tbody peut être vide. {% endcomment %}
          {% for doc in page_obj %}
          <tr>
            <td class="fw-semibold">{{ doc.Discipline }}</td>
            <td>{{ doc.Titre }}</td>
            <td><span class="badge bg-info text-dark">{{ doc.TypeDoc }}</span></td>
            <td class="text-center">
              {% if doc.Document %}
                <a href="{{ doc.Document.url }}" download class="btn btn-sm btn-outline-primary">Télécharger</a>
              {% else %}
                <span class="text-muted small">Aucun</span>
              {% endif %}
            </td>
            <td class="text-center">
              {% if doc.TypeDoc != "Cours" %}
                <a href="{% url 'Ajouter_Solution' doc.id %}">
                  <img src="{% static 'images/Logo/plus.png' %}" width="26" alt="Ajouter">
                </a>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td class="text-center">
              <a href="{% url 'Modifier_document' doc.id %}" class="btn btn-sm btn-outline-success">Modifier</a>
            </td>
            <td class="text-center">
              <a href="{% url 'SupDocuments' doc.id %}" onclick="return confirm('Voulez-vous vraiment supprimer ?')" class="btn btn-sm btn-outline-danger">
                <img src="{% static 'images/Logo/corbeille.png' %}" width="20" alt="Supprimer">
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Pagination Django -->
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ q }}&discipline={{ discipline_selected }}&typedoc={{ typedoc_selected }}">&laquo;</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <li class="page-item"><a class="page-link" href="?page={{ num }}&q={{ q }}&discipline={{ discipline_selected }}&typedoc={{ typedoc_selected }}">{{ num }}</a></li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ q }}&discipline={{ discipline_selected }}&typedoc={{ typedoc_selected }}">&raquo;</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
          {% endif %}
        </ul>
      </nav>

    </div>

        <div class="col-md-3 col-xs-3 col-sm-3 col-lg-3 m-3 shadow">
            <div class="m-3"><center><button  class="btn btn-info "><b>MODIFIER LE DOCUMENT</b></button></center></div>
            <hr>
             <div class="col-md-12 col-xs-12 col-sm-12 col-lg-12 ">
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} shadow">{{ message }}</div>
                    {% endfor %}
                {% endif%}
            </div>
            <hr>
            <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="form-group">
      <label for="id_Titre">Titre</label>
      {{ form.Titre }}
    </div>

    <div class="form-group">
      <label for="id_Discipline">Discipline</label>
      {{ form.Discipline }}
    </div>

    <div class="form-group">
      <label for="id_Niveau">Niveau</label>
      {{ form.Niveau }}
    </div>

    <div class="form-group">
      <label for="id_TypeDoc">Type de document</label>
      {{ form.TypeDoc }}
    </div>

    <div class="form-group">
      <label for="id_Etat">État</label>
      {{ form.Etat }}
    </div>

    <div class="form-group">
      <label for="id_Observation">Observation</label>
      {{ form.Observation }}
    </div>

    <div class="form-group">
      <label>Fichier actuel :</label><br>
      <a href="{{ document.Document.url }}" target="_blank">Télécharger</a>
    </div>

    <div class="form-group">
      <label for="id_Document">Remplacer le fichier</label>
      {{ form.Document }}
    </div>
            <center><button type="submit" class="btn btn-primary">Enregistrer</button></center>
          </form>
        </div>

    </div>
</div>
<script>
function validateFileSize(input) {
    const file = input.files[0];
    if (file) {
        const maxSize = 20 * 1024 * 1024; // 20 Mo
        const allowedExtensions = ['.pdf', '.doc', '.docx', '.xls', '.xlsx', '.png', '.jpeg', '.jpg'];
        const ext = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();

        if (file.size > maxSize) {
            alert("⚠️ Le fichier dépasse 20 Mo.");
            input.value = "";
        } else if (!allowedExtensions.includes(ext)) {
            alert("⚠️ Type de fichier non autorisé : " + ext);
            input.value = "";
        }
    }
}
</script>


{% endblock content %}