{% extends "Menus/MenuEspaceForm.html" %}
{% block content %}
{% load static %}

<div class="container-fluid py-3">
    <!-- En-tête du groupe -->
    <div class="d-flex align-items-center bg-light p-3 rounded shadow-sm mb-3">
        <img src="{{ nomgroup.logo.url }}" alt="Logo du groupe" class="img-fluid me-3" style="width: 60px; height: auto;">
        <h5 class="m-0 text-danger">
            Groupe {{ nomgroup.Groupe }} - <small>ID : {{ nomgroup.id }}</small>
        </h5>
    </div>

    <hr>

    <!-- Titre principal -->
    <div class="text-center mb-4">
        <img width="60" src="https://www.egfbtp.com/wp-content/uploads/2021/06/partenariat.jpg" class="img-fluid mb-2" alt="FaceSchool">
        <h5 class="fw-bold">
            Documents du Groupe de Travail Partenaire N°: {{ pk }}
        </h5>
    </div>

    <div class="row justify-content-center">
        <!-- Colonne gauche -->
        <div class="col-lg-3 col-md-4 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header text-center bg-success text-white fw-bold">
                    Type de Documents
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover table-striped m-0">
                        <tbody>
                            {% for type in TypeDocs %}
                                <tr>
                                    <td>
                                        <a href="{% url 'ListeDocGRPTravPartenTypeDoc' pk type.TypeDoc %}" class="text-decoration-none fw-semibold">
                                            {{ type.TypeDoc }}
                                        </a>
                                    </td>
                                </tr>
                            {% empty %}
                                <tr><td class="text-danger text-center">Aucun type disponible</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Colonne droite -->
        <div class="col-lg-8 col-md-8">
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} shadow-sm">{{ message }}</div>
                {% endfor %}
            {% endif %}

            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white fw-bold d-flex flex-wrap justify-content-between align-items-center">
                    <span>Liste des Documents</span>

                    <!-- Zone de filtres -->
                    <div class="d-flex flex-wrap gap-2 align-items-center">
                        <select id="filterType" class="form-select form-select-sm w-auto">
                            <option value="">Tous les types</option>
                            {% for t in TypeDocs %}
                                <option value="{{ t.TypeDoc }}">{{ t.TypeDoc }}</option>
                            {% endfor %}
                        </select>

                        <select id="filterNiveau" class="form-select form-select-sm w-auto">
                            <option value="">Tous les niveaux</option>
                            {% for n in niveau %}
                                <option value="{{ n.niveau }}">{{ n.niveau }}</option>
                            {% endfor %}
                        </select>

                        <input type="text" id="searchInput" class="form-control form-control-sm w-auto" placeholder="Rechercher...">

                        <!-- Boutons d'export -->
                        <button id="exportExcel" class="btn btn-light btn-sm border">Excel</button>
                        <button id="exportPDF" class="btn btn-light btn-sm border">PDF</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table id="docTable" class="table table-striped table-bordered mb-0 align-middle">
                        <thead class="table-success text-center">
                            <tr>
                                <th>Discipline</th>
                                <th>Niveau</th>
                                <th>Type</th>
                                <th>Titre</th>
                                <th>Document</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for Listes in ListeDossiers %}
                                <tr>
                                    <td>{{ Listes.Discipline_id }}</td>
                                    <td>{{ Listes.Niveau_id }}</td>
                                    <td>{{ Listes.TypeDoc_id }}</td>
                                    <td>{{ Listes.Titre }}</td>
                                    <td>
                                        <a href="{{ Listes.Document.url }}" class="btn btn-sm btn-outline-primary" download>
                                            Télécharger
                                        </a>
                                    </td>
                                    <td>{{ Listes.create_at|date:"d/m/Y H:i" }}</td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-danger">Aucun document trouvé.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="card-footer d-flex justify-content-between align-items-center">
                    <span id="paginationInfo" class="small text-muted"></span>
                    <div>
                        <button id="prevPage" class="btn btn-outline-secondary btn-sm me-1">Précédent</button>
                        <button id="nextPage" class="btn btn-outline-secondary btn-sm">Suivant</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- === Script de gestion === -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const rows = Array.from(document.querySelectorAll("#docTable tbody tr"));
    const searchInput = document.getElementById("searchInput");
    const filterType = document.getElementById("filterType");
    const filterNiveau = document.getElementById("filterNiveau");
    const perPage = 8; // lignes par page
    let currentPage = 1;

    function filterAndRender() {
        const searchVal = searchInput.value.toLowerCase();
        const typeVal = filterType.value.toLowerCase();
        const nivVal = filterNiveau.value.toLowerCase();

        const filtered = rows.filter(row => {
            const text = row.textContent.toLowerCase();
            const type = row.cells[2]?.textContent.toLowerCase() || "";
            const niveau = row.cells[1]?.textContent.toLowerCase() || "";
            return (
                text.includes(searchVal) &&
                (!typeVal || type.includes(typeVal)) &&
                (!nivVal || niveau.includes(nivVal))
            );
        });

        renderPage(filtered);
    }

    function renderPage(filteredRows) {
        const tbody = document.querySelector("#docTable tbody");
        tbody.innerHTML = "";

        const start = (currentPage - 1) * perPage;
        const end = start + perPage;
        const pageRows = filteredRows.slice(start, end);

        pageRows.forEach(r => tbody.appendChild(r));
        document.getElementById("paginationInfo").textContent =
            `Page ${currentPage} / ${Math.ceil(filteredRows.length / perPage)} (${filteredRows.length} documents)`;
    }

    document.getElementById("nextPage").addEventListener("click", () => {
        currentPage++;
        filterAndRender();
    });

    document.getElementById("prevPage").addEventListener("click", () => {
        if (currentPage > 1) currentPage--;
        filterAndRender();
    });

    [searchInput, filterType, filterNiveau].forEach(el => el.addEventListener("input", () => {
        currentPage = 1;
        filterAndRender();
    }));

    filterAndRender();

    // === Export Excel ===
    document.getElementById("exportExcel").addEventListener("click", function() {
        let table = document.getElementById("docTable").outerHTML;
        let blob = new Blob([table], { type: "application/vnd.ms-excel" });
        let link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "documents_groupe.xls";
        link.click();
    });

    // === Export PDF ===
    document.getElementById("exportPDF").addEventListener("click", function() {
        window.print(); // simple, pratique, imprime la page ou exporte en PDF
    });
});
</script>


{% endblock content %}